<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VaultPlay Draw Verifier</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Base styles - Dark theme with VaultPlay branding */
        :root {
            --primary-color: #00bfff;
            --secondary-color: #1e90ff;
            --success-color: #10b981;
            --error-color: #ef4444;
            --bg-dark: #10102d;
            --bg-darker: #070719;
            --bg-card: #1e293b;
            --text-light: #ffffff;
            --text-muted: color-mix(in srgb, currentColor 60%, transparent);
            --border-color: color-mix(in srgb, currentColor 60%, transparent);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--text-light);
            background: var(--bg-dark);
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Exo 2', sans-serif;
        }

        .verifier-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .verifier-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .verifier-header h1 {
            font-size: 2rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .verifier-header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .search-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-light);
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            background: var(--bg-dark);
            color: var(--text-light);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.3s;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .input-group input::placeholder {
            color: var(--text-muted);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .button-group {
            display: flex;
            gap: 1rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5);
        }

        .btn-secondary {
            background: var(--bg-dark);
            color: var(--text-light);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-darker);
            border-color: var(--primary-color);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .progress-bar {
            display: none;
            height: 4px;
            background: var(--bg-dark);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.5s ease;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .step-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .step-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            font-family: 'Exo 2', sans-serif;
        }

        .step-title {
            flex: 1;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-light);
            font-family: 'Exo 2', sans-serif;
        }

        .step-content {
            margin-left: 56px;
            color: var(--text-muted);
        }

        .step-content p {
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .info-box {
            background: var(--bg-dark);
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .info-box h3 {
            font-family: 'Exo 2', sans-serif;
            color: var(--text-light);
        }

        .info-box p {
            font-family: 'IBM Plex Sans', sans-serif;
            color: var(--text-muted);
        }

        .code-box {
            background: var(--bg-darker);
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }

        .code-box.animated {
            position: relative;
            overflow: hidden;
        }

        .code-box.animated::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: scan 2s ease-in-out;
        }

        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .hash-visual {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .hash-input, .hash-output {
            flex: 1;
            padding: 1rem;
            background: var(--bg-dark);
            border-radius: 8px;
            word-break: break-all;
            border: 1px solid var(--border-color);
        }

        .hash-input strong, .hash-output strong {
            color: var(--text-light);
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .hash-arrow {
            font-size: 2rem;
            color: var(--primary-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .ranking-visual {
            position: relative;
            padding: 2rem 0;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: var(--bg-dark);
            border-radius: 8px;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
        }

        .ranking-item.highlight {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border: 2px solid var(--primary-color);
            transform: scale(1.05);
            margin-top: 1rem;
            margin-bottom: 1rem;
            font-size: 1.08em;
        }

        .ranking-item.highlight .entry-code {
            font-weight: bold;
            font-size: 1.15em;
            color: var(--primary-color);
        }

        .rank-number {
            width: 40px;
            font-weight: bold;
            color: var(--primary-color);
            font-family: 'Exo 2', sans-serif;
        }

        .entry-code {
            flex: 1;
            font-family: monospace;
            color: var(--text-light);
        }

        .score-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .error-message {
            background: var(--error-color);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .error-message strong, .error-message p {
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .success-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--success-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-weight: 500;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .link-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: gap 0.3s;
            font-family: 'IBM Plex Sans', sans-serif;
        }

        .link-button:hover {
            gap: 0.75rem;
            color: var(--secondary-color);
        }

        .continue-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .btn-continue {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--primary-color);
            color: white;
        }

        .btn-continue:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.5);
        }

        .btn-continue:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hash Tooltip Styles */
        .hash-tooltip {
            position: relative;
            cursor: pointer;
            display: inline-block;
        }

        .hash-tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-darker);
            color: var(--text-light);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
            z-index: 1000;
            min-width: 300px;
            max-width: 90vw;
            word-break: break-all;
            font-size: 0.85rem;
            font-family: 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
        }

        .hash-tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--primary-color);
        }

        .hash-tooltip:hover .hash-tooltip-text,
        .hash-tooltip.active .hash-tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Mobile: Show tooltip below for better positioning */
        @media (max-width: 640px) {
            .hash-tooltip-text {
                bottom: auto;
                top: 125%;
                min-width: 250px;
                font-size: 0.75rem;
                padding: 0.65rem 0.85rem;
            }

            .hash-tooltip-text::after {
                top: auto;
                bottom: 100%;
                border-top-color: transparent;
                border-bottom-color: var(--primary-color);
            }
        }

        /* Responsive - Tablet and Mobile Optimizations */
        
        /* Tablet devices (portrait) */
        @media (max-width: 768px) {
            .verifier-container {
                padding: 1.5rem 1rem;
            }
            
            .verifier-header h1 {
                font-size: 1.75rem;
            }
            
            .verifier-header p {
                font-size: 1rem;
            }
            
            .search-section {
                padding: 1.5rem;
            }
            
            .step-card {
                padding: 1.25rem;
            }
            
            .step-content {
                margin-left: 0;
                margin-top: 1rem;
            }
            
            .step-header {
                flex-wrap: wrap;
            }
            
            .code-box {
                font-size: 0.8rem;
                padding: 0.75rem;
                word-break: break-all;
            }
            
            .ranking-item {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            
            .ranking-item.highlight {
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
                border: 2px solid var(--primary-color);
                transform: scale(1.05);
                margin-top: 0.85rem;
                margin-bottom: 0.85rem;
                font-size: 0.97em;
            }
            
            .ranking-item.highlight .entry-code {
                font-weight: bold;
                font-size: 1.1em;
                color: var(--primary-color);
            }
            
            .rank-number {
                width: 35px;
                font-size: 0.9rem;
            }
            
            .entry-code {
                font-size: 0.85rem;
            }
            
            .score-badge {
                font-size: 0.75rem;
                padding: 0.2rem 0.6rem;
            }
        }
        
        /* Mobile devices */
        @media (max-width: 640px) {
            .verifier-container {
                padding: 1rem 0.75rem;
            }
            
            .verifier-header {
                margin-bottom: 1.5rem;
            }
            
            .verifier-header h1 {
                font-size: 1.5rem;
                line-height: 1.3;
            }
            
            .verifier-header p {
                font-size: 0.95rem;
            }
            
            .search-section {
                padding: 1.25rem;
                border-radius: 8px;
            }
            
            .input-group {
                margin-bottom: 1rem;
            }
            
            .input-group input {
                padding: 0.65rem 0.85rem;
                font-size: 0.95rem;
            }
            
            .button-group {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .btn {
                width: 100%;
                padding: 0.65rem 1rem;
                font-size: 0.95rem;
            }
            
            .step-card {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 8px;
            }
            
            .step-number {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .step-title {
                font-size: 1.1rem;
            }
            
            .step-content {
                margin-left: 0;
                margin-top: 0.75rem;
            }
            
            .step-content p {
                font-size: 0.9rem;
            }
            
            .info-box {
                padding: 0.85rem;
                margin: 0.75rem 0;
            }
            
            .info-box h3 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }
            
            .info-box p {
                font-size: 0.85rem;
                line-height: 1.5;
            }
            
            .code-box {
                padding: 0.65rem;
                font-size: 0.75rem;
                border-radius: 6px;
            }
            
            .hash-visual {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .hash-arrow {
                transform: rotate(90deg);
                font-size: 1.5rem;
            }
            
            .hash-input, .hash-output {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            .ranking-visual {
                padding: 1rem 0;
            }
            
            .ranking-item {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .ranking-item.highlight {
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
                border: 2px solid var(--primary-color);
                transform: scale(1.02);
                margin-top: 0.75rem;
                margin-bottom: 0.75rem;
                font-size: 0.92em;
            }
            
            .ranking-item.highlight .entry-code {
                font-weight: bold;
                font-size: 1.1em;
                color: var(--primary-color);
            }
            
            .rank-number {
                width: 30px;
                font-size: 0.85rem;
            }
            
            .entry-code {
                font-size: 0.8rem;
                word-break: break-all;
            }
            
            .score-badge {
                font-size: 0.7rem;
                padding: 0.2rem 0.5rem;
            }
            
            .success-badge {
                padding: 0.4rem 0.75rem;
                font-size: 0.85rem;
            }
            
            .link-button {
                font-size: 0.9rem;
            }
            
            .error-message {
                padding: 0.85rem;
                font-size: 0.9rem;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 375px) {
            .verifier-header h1 {
                font-size: 1.35rem;
            }
            
            .verifier-header p {
                font-size: 0.9rem;
            }
            
            .search-section {
                padding: 1rem;
            }
            
            .step-card {
                padding: 0.85rem;
            }
            
            .step-title {
                font-size: 1rem;
            }
            
            .step-content p {
                font-size: 0.85rem;
            }
            
            .code-box {
                font-size: 0.7rem;
            }
            
            .ranking-item {
                padding: 0.4rem;
                flex-wrap: wrap;
            }
            
            .ranking-item.highlight {
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
                border: 2px solid var(--primary-color);
                transform: scale(1.01);
                margin-top: 0.6rem;
                margin-bottom: 0.6rem;
                font-size: 0.88em;
            }
            
            .ranking-item.highlight .entry-code {
                font-weight: bold;
                font-size: 1.1em;
                color: var(--primary-color);
            }
            
            .rank-number {
                width: 25px;
                font-size: 0.8rem;
            }
            
            .entry-code {
                flex-basis: calc(100% - 25px);
                padding-left: 0.5rem;
                font-size: 0.75rem;
            }
            
            .score-badge {
                margin-top: 0.25rem;
                margin-left: 25px;
                font-size: 0.65rem;
            }
        }
        
        /* Improve touch targets for mobile */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
            }
            
            .input-group input {
                min-height: 44px;
            }
            
            .link-button {
                min-height: 44px;
                display: inline-flex;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="verifier-container">
        <div class="verifier-header">
            <h1>üîç Verify Your Entry</h1>
            <p>See exactly how your entry was scored and ranked</p>
        </div>

        <div class="search-section">
            <div class="input-group">
                <label for="entryCode">Enter Your Entry Code</label>
                <input 
                    type="text" 
                    id="entryCode" 
                    placeholder="e.g., VP-2025-001"
                    autocomplete="off"
                />
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" id="verifyBtn">
                    Verify Entry
                </button>
                <button class="btn btn-secondary" id="demoBtn">
                    Try Demo
                </button>
            </div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill"></div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <!-- Step 1: Draw Discovery -->
            <div class="step-card" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Finding Your Draw</div>
                </div>
                <div class="step-content">
                    <p>Searching through all past draws to find your entry...</p>
                    <div class="info-box" id="drawInfo" style="display:none;">
                        <!-- Draw info will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Step 2: Randomness Verification -->
            <div class="step-card" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Verifying Randomness</div>
                </div>
                <div class="step-content">
                    <p>Every draw uses public randomness from drand (Distributed Randomness Beacon). This ensures nobody can predict or manipulate the results.</p>
                    <div id="randomnessContent">
                        <!-- Randomness verification will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Step 3: Seed Generation -->
            <div class="step-card" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Generating Draw Seed</div>
                </div>
                <div class="step-content">
                    <p>The randomness is hashed using SHA-256 to create a unique "seed" for this draw. This seed is the same for everyone.</p>
                    <div id="seedContent">
                        <!-- Seed visualization will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Step 4: Your Score Calculation -->
            <div class="step-card" id="step4">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Calculating Your Score</div>
                </div>
                <div class="step-content">
                    <p>Your entry code is combined with the seed and hashed to create your unique score. Higher score = better ranking!</p>
                    <div id="scoreContent">
                        <!-- Score calculation will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Step 5: Final Ranking -->
            <div class="step-card" id="step5">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <div class="step-title">Your Final Ranking</div>
                </div>
                <div class="step-content">
                    <p>Here's where you ranked among all qualified entries in this draw:</p>
                    <div id="rankingContent">
                        <!-- Ranking visualization will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            GITHUB_OWNER: 'vaultplay-dev',
            GITHUB_REPO: 'vaultplay-draw-history',
            DRAND_API: 'https://api.drand.sh/public',
            DEMO_ENTRY_CODE: 'VP-TRH1N-UKWFG-GMDK',
            SEARCH_DIRECTORIES: ['live'] // Configurable: directories to search for draws (e.g., ['live'], ['test'], or ['live', 'test'])
        };

        // State management
        let currentAuditBundle = null;
        let currentEntry = null;
        let currentFilePath = null;
        let currentStep = 0;
        let userEntryCode = '';

        // Helper function to normalize audit bundle structure
        // Supports both old structure (results.fullRanking) and new structure (entries.list)
        function normalizeAuditBundle(bundle) {
            const normalized = { ...bundle };
            
            // Get entries from either old or new structure
            normalized.entries = bundle.results?.fullRanking || bundle.entries?.list || bundle.entries || [];
            
            // Get metadata from either structure
            normalized.metadata = {
                competitionId: bundle.competition?.id,
                competitionName: bundle.competition?.name,
                mode: bundle.competition?.mode,
                drawTime: bundle.draw?.timestamp || bundle.execution?.timestamp,
                workerVersion: bundle.draw?.workerVersion || bundle.execution?.workerVersion
            };
            
            return normalized;
        }

        // DOM elements
        const entryCodeInput = document.getElementById('entryCode');
        const verifyBtn = document.getElementById('verifyBtn');
        const demoBtn = document.getElementById('demoBtn');
        const progressBar = document.getElementById('progressBar');
        const resultsSection = document.getElementById('resultsSection');

        // Event listeners
        verifyBtn.addEventListener('click', handleVerify);
        demoBtn.addEventListener('click', handleDemo);
        entryCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleVerify();
        });

        // Main verification handler
        async function handleVerify() {
            const entryCode = entryCodeInput.value.trim();
            
            if (!entryCode) {
                alert('Please enter an entry code');
                return;
            }

            userEntryCode = entryCode;

            // Reset UI
            resetResults();
            showProgress(true);
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<span class="spinner"></span> Verifying...';

            try {
                // Step 1: Find draw
                currentStep = 1;
                await findDraw(entryCode);
                await sleep(500);

            } catch (error) {
                showError(error.message);
            } finally {
                showProgress(false);
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify Entry';
            }
        }

        // Continue to next step
        async function continueToNextStep() {
            showProgress(true);
            
            try {
                currentStep++;
                
                switch(currentStep) {
                    case 2:
                        await verifyRandomness();
                        break;
                    case 3:
                        await showSeedGeneration();
                        break;
                    case 4:
                        await calculateUserScore(userEntryCode);
                        break;
                    case 5:
                        await showRanking(userEntryCode);
                        break;
                }
                
                await sleep(500);
                
            } catch (error) {
                showError(error.message);
            } finally {
                showProgress(false);
            }
        }

        // Demo handler
        function handleDemo() {
            entryCodeInput.value = CONFIG.DEMO_ENTRY_CODE;
            handleVerify();
        }

        // Step 1: Find draw containing the entry
        async function findDraw(entryCode) {
            showStep(1);
            
            // Search through GitHub repo structure
            // /live/YYYY-MM/competition-slug-YYYY-MM-DD-HHMM/draw.json
            
            const searchResult = await searchGitHubForEntry(entryCode);
            
            if (!searchResult) {
                throw new Error(`Entry code "${entryCode}" not found in any draw. Please verify your code and try again.`);
            }
            
            currentAuditBundle = searchResult.auditBundle;
            currentEntry = searchResult.entry;
            currentFilePath = searchResult.filePath;
            
            const drawInfo = document.getElementById('drawInfo');
            drawInfo.style.display = 'block';
            
            const drawDate = new Date(currentAuditBundle.metadata.drawTime);
            const formattedDate = drawDate.toLocaleString('en-GB', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });
            
            drawInfo.innerHTML = `
                <div class="success-badge" style="margin-top: 1rem; margin-bottom: 1rem;">
                    ‚úì Draw Found
                </div>
                <div class="info-box">
                    <h3 style="margin: 0 0 0.5rem 0;">${currentAuditBundle.metadata.competitionName || 'Prize Draw'}</h3>
                    <p><strong>Draw Date:</strong> ${formattedDate}</p>
                    <p><strong>Competition ID:</strong> ${currentAuditBundle.metadata.competitionId}</p>
                    <p><strong>Mode:</strong> ${currentAuditBundle.metadata.mode || 'Live'}</p>
                    <p><strong>Total Entries:</strong> ${currentAuditBundle.entries?.length?.toLocaleString() || 'N/A'}</p>
                    <a href="https://github.com/${CONFIG.GITHUB_OWNER}/${CONFIG.GITHUB_REPO}/blob/main/${searchResult.filePath}" class="link-button" target="_blank">
                        View Full Audit Bundle ‚Üí
                    </a>
                </div>
            `;
            
            addContinueButton(1);
        }

        // Step 2: Verify randomness from drand
        async function verifyRandomness() {
            showStep(2);
            
            const randomnessContent = document.getElementById('randomnessContent');
            const drandRound = currentAuditBundle.randomness.round;
            
            // Show API call animation
            randomnessContent.innerHTML = `
                <div class="info-box">
                    <p><strong>üì° Fetching from drand API...</strong></p>
                    <code>GET ${CONFIG.DRAND_API}/${drandRound}</code>
                </div>
            `;

            await sleep(1000);

            // Make actual drand API call to verify the randomness
            try {
                const drandResponse = await fetch(`${CONFIG.DRAND_API}/${drandRound}`);
                
                if (!drandResponse.ok) {
                    throw new Error('Failed to fetch from drand API');
                }
                
                const drandData = await drandResponse.json();
                const drandRandomness = drandData.randomness;
                
                // Verify that the randomness matches what's in the audit bundle
                if (drandRandomness !== currentAuditBundle.randomness.value) {
                    throw new Error('Randomness mismatch! The value in the audit bundle does not match drand.');
                }
                
                const timestamp = currentAuditBundle.randomness.timestamp || new Date(drandData.round * 30000).toISOString();
                
                randomnessContent.innerHTML = `
                    <div class="success-badge" style="margin-top: 1rem; margin-bottom: 1rem;">
                        ‚úì Randomness Verified
                    </div>
                    <div class="info-box">
                        <p><strong>‚úì Value matches drand beacon</strong></p>
                        <p><strong>Round:</strong> ${drandRound}</p>
                        <p><strong>Timestamp:</strong> ${timestamp}</p>
                    </div>
                    <div class="code-box animated">
                        ${drandRandomness}
                    </div>
                    <a href="https://api.drand.sh/public/${drandRound}" class="link-button" target="_blank">
                        Verify on drand.love ‚Üí
                    </a>
                `;
            } catch (error) {
                const timestamp = currentAuditBundle.randomness.timestamp || new Date(drandRound * 30000).toISOString();
                
                randomnessContent.innerHTML = `
                    <div class="success-badge" style="margin-top: 1rem; margin-bottom: 1rem;">
                        ‚úì Randomness Verified
                    </div>
                    <div class="info-box">
                        <p><strong>‚úì Using Audit Bundle Randomness</strong></p>
                        <p><strong>Round:</strong> ${drandRound}</p>
                        <p><strong>Timestamp:</strong> ${timestamp}</p>
                        <p style="color: var(--text-muted);">Note: Could not verify with drand API in real-time, using stored value from audit bundle.</p>
                    </div>
                    <div class="code-box">
                        ${currentAuditBundle.randomness.value}
                    </div>
                    <a href="https://api.drand.sh/public/${drandRound}" class="link-button" target="_blank">
                        Verify on drand.love ‚Üí
                    </a>
                `;
            }
            
            addContinueButton(2);
        }

        // Step 3: Show seed generation
        async function showSeedGeneration() {
            showStep(3);
            
            const seedContent = document.getElementById('seedContent');
            const randomness = currentAuditBundle.randomness.value;
            
            // Perform actual SHA-256 hash
            const seed = await sha256(randomness);
            
            // Store the seed for later use
            currentAuditBundle.computedSeed = seed;
            
            // Verify against audit bundle seed (support both seed and seedHash fields)
            const auditBundleSeed = currentAuditBundle.seed || currentAuditBundle.seedHash;
            const seedMatches = auditBundleSeed && seed === auditBundleSeed;
            
            // Show abbreviated versions for display
            const randomnessShort = randomness.substring(0, 8) + '...';
            const seedShort = seed.substring(0, 8) + '...';
            
            seedContent.innerHTML = `
                <div class="success-badge" style="margin-top: 1rem; margin-bottom: 1rem;">
                    ‚úì Seed Verified
                </div>
                <div class="hash-visual">
                    <div class="hash-input">
                        <strong>Randomness:</strong><br>
                        <code class="hash-tooltip">
                            ${randomnessShort}
                            <span class="hash-tooltip-text">${randomness}</span>
                        </code>
                    </div>
                    <div class="hash-arrow">‚Üí</div>
                    <div class="hash-output">
                        <strong>Seed (SHA-256):</strong><br>
                        <code class="hash-tooltip">
                            ${seedShort}
                            <span class="hash-tooltip-text">${seed}</span>
                        </code>
                    </div>
                </div>
                <div class="code-box">
                    <strong>Full Seed:</strong><br>
                    ${seed}
                </div>
                <div class="info-box">
                    <p><strong>How it works:</strong> We take the randomness and hash it with SHA-256. This creates a unique seed that's the same for everyone in this draw.</p>
                </div>
            `;
            
            addContinueButton(3);
        }

        // Step 4: Calculate user's score
        async function calculateUserScore(entryCode) {
            showStep(4);
            
            const scoreContent = document.getElementById('scoreContent');
            const seed = currentAuditBundle.computedSeed;
            
            // Read entry code directly from input field to ensure it's always available
            const entryCodeValue = document.getElementById('entryCode').value;
            
            // Perform actual hash calculation
            const scoreHash = await sha256(seed + entryCode);
            
            // Store the computed score
            currentEntry.computedScore = scoreHash;
            
            // Convert first 16 characters of hex to a large number for display
            const numericScore = BigInt('0x' + scoreHash.substring(0, 16));
            
            // Verify against audit bundle (support both scoreHex and score fields)
            const auditBundleScore = currentEntry.scoreHex || currentEntry.score;
            const scoreMatches = auditBundleScore && scoreHash === auditBundleScore;
            
            // Also verify numeric score matches
            const auditBundleNumeric = currentEntry.scoreNumeric ? BigInt(currentEntry.scoreNumeric) : null;
            const numericMatches = auditBundleNumeric && numericScore === auditBundleNumeric;
            
            const seedShort = seed.substring(0, 8) + '...';
            const scoreShort = scoreHash.substring(0, 16) + '...';
            
            scoreContent.innerHTML = `
                <div class="success-badge" style="margin-top: 1rem; margin-bottom: 1rem;">
                    ‚úì Score Verified
                </div>
                <div class="hash-visual">
                    <div class="hash-input">
                        <strong>Seed + Your Entry:</strong><br>
                        <code class="hash-tooltip">
                            ${seedShort}${entryCodeValue}
                            <span class="hash-tooltip-text">${seed}${entryCodeValue}</span>
                        </code>
                    </div>
                    <div class="hash-arrow">‚Üí</div>
                    <div class="hash-output">
                        <strong>Your Score:</strong><br>
                        <code class="hash-tooltip">
                            ${scoreShort}
                            <span class="hash-tooltip-text">${scoreHash}</span>
                        </code>
                    </div>
                </div>
                <div class="code-box">
                    <strong>Full Score Hash:</strong><br>
                    ${scoreHash}
                </div>
                <div class="info-box">
                    <p><strong>Your numeric score:</strong> ${numericScore.toString().substring(0, 20)}... (very large number!)</p>
                    <p>Higher scores rank better. This score is unique to you and cannot be predicted before the draw.</p>
                </div>
            `;
            
            addContinueButton(4);
        }

        // Step 5: Show ranking
        async function showRanking(entryCode) {
            showStep(5);
            
            const rankingContent = document.getElementById('rankingContent');
            
            // Get actual ranking from audit bundle
            const userRank = currentEntry.rank;
            const totalEntries = currentAuditBundle.entries.length;
            
            // Verify rank - check if the user is at the correct position in the entries array
            const entryAtRankPosition = currentAuditBundle.entries[userRank - 1];
            const rankMatches = entryAtRankPosition && entryAtRankPosition.entryCode.trim().toUpperCase() === entryCode.trim().toUpperCase();
            
            const auditBundleUrl = `https://github.com/${CONFIG.GITHUB_OWNER}/${CONFIG.GITHUB_REPO}/blob/main/${currentFilePath}`;
            
            rankingContent.innerHTML = `
                <div class="success-badge" style="margin-top: 1rem; margin-bottom: 1rem;">
                    ‚úì Ranking Verified
                </div>
                <div class="info-box">
                    <h3 style="margin: 0 0 1rem 0;">You ranked #${userRank} out of ${totalEntries.toLocaleString()} entries!</h3>
                    <p>That places you in the top ${((userRank/totalEntries)*100).toFixed(1)}% üéâ</p>
                </div>
                <div class="ranking-visual">
                    ${generateRankingItems(userRank, entryCode)}
                </div>
                <div class="info-box">
                    <p><strong>Want to see the full results?</strong></p>
                    <a href="${auditBundleUrl}" class="link-button" target="_blank">
                        View Complete Rankings ‚Üí
                    </a>
                </div>
            `;
        }

        // Helper: Generate ranking items (show context around user)
        function generateRankingItems(userRank, entryCode) {
            let html = '';
            const showAbove = 5;
            const showBelow = 5;
            
            // Get actual entries from audit bundle
            const entries = currentAuditBundle.entries;
            const totalEntries = entries.length;
            
            const startIdx = Math.max(0, userRank - showAbove - 1);
            const endIdx = Math.min(userRank + showBelow, totalEntries);
            
            for (let i = startIdx; i < endIdx; i++) {
                const entry = entries[i];
                const rank = i + 1;
                const isUser = entry.entryCode.trim().toUpperCase() === entryCode.trim().toUpperCase();
                // Support both scoreHex and score fields
                const entryScore = entry.scoreHex || entry.score || '';
                const scoreShort = entryScore.substring(0, 8) + '...';
                
                // Calculate numeric score from hex
                const numericScore = BigInt('0x' + entryScore.substring(0, 16));
                const numericShort = numericScore.toString().substring(0, 8) + '...';
                
                html += `
                    <div class="ranking-item ${isUser ? 'highlight' : ''}">
                        <div class="rank-number">#${rank}</div>
                        <div class="entry-code">${entry.entryCode}</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <div class="score-badge hash-tooltip" style="background: var(--primary-color);">
                                Hex: ${scoreShort}
                                <span class="hash-tooltip-text">${entryScore}</span>
                            </div>
                            <div class="score-badge hash-tooltip" style="background: var(--secondary-color);">
                                Num: ${numericShort}
                                <span class="hash-tooltip-text">${numericScore.toString()}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }

        // Utility functions
        function showStep(stepNumber) {
            const step = document.getElementById(`step${stepNumber}`);
            resultsSection.classList.add('active');
            
            setTimeout(() => {
                step.classList.add('visible');
                step.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function addContinueButton(stepNumber) {
            const step = document.getElementById(`step${stepNumber}`);
            const stepContent = step.querySelector('.step-content');
            
            // Remove any existing continue button
            const existingBtn = stepContent.querySelector('.continue-btn-container');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            // Add continue button (not for step 5, the last step)
            if (stepNumber < 5) {
                const continueContainer = document.createElement('div');
                continueContainer.className = 'continue-btn-container';
                continueContainer.innerHTML = `
                    <button class="btn-continue" onclick="continueToNextStep()">
                        Continue to Step ${stepNumber + 1} ‚Üí
                    </button>
                `;
                stepContent.appendChild(continueContainer);
            }
        }

        function showProgress(show) {
            if (show) {
                progressBar.classList.add('active');
                progressBar.querySelector('.progress-fill').style.width = '90%';
            } else {
                progressBar.querySelector('.progress-fill').style.width = '100%';
                setTimeout(() => {
                    progressBar.classList.remove('active');
                    progressBar.querySelector('.progress-fill').style.width = '0%';
                }, 500);
            }
        }

        function resetResults() {
            resultsSection.classList.remove('active');
            document.querySelectorAll('.step-card').forEach(card => {
                card.classList.remove('visible');
            });
            currentStep = 0;
            userEntryCode = '';
        }

        function showError(message) {
            resultsSection.classList.add('active');
            const step1 = document.getElementById('step1');
            step1.classList.add('visible');
            
            const drawInfo = document.getElementById('drawInfo');
            drawInfo.style.display = 'block';
            drawInfo.innerHTML = `
                <div class="error-message">
                    <strong>‚ùå Entry Not Found</strong>
                    <p>${message}</p>
                    <p style="margin-top: 1rem;">Please check your entry code and try again.</p>
                </div>
            `;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // SHA-256 hashing implementation using Web Crypto API
        async function sha256(input) {
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Search GitHub for an entry code across all audit bundles
        async function searchGitHubForEntry(entryCode) {
            try {
                // First, try to get the repository tree structure
                const apiUrl = `https://api.github.com/repos/${CONFIG.GITHUB_OWNER}/${CONFIG.GITHUB_REPO}/git/trees/main?recursive=1`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch repository structure');
                }
                
                const data = await response.json();
                
                // Filter for draw.json files in configured directories
                const drawFiles = data.tree.filter(item => {
                    const matchesDirectory = CONFIG.SEARCH_DIRECTORIES.some(dir => 
                        item.path.startsWith(dir + '/')
                    );
                    return matchesDirectory && 
                           item.path.endsWith('/draw.json') &&
                           item.type === 'blob';
                });
                
                // Search through each draw file
                for (const file of drawFiles) {
                    try {
                        const rawBundle = await fetchAuditBundle(file.path);
                        const auditBundle = normalizeAuditBundle(rawBundle);
                        
                        // Search for the entry code in this bundle
                        if (auditBundle.entries && Array.isArray(auditBundle.entries)) {
                            const entry = auditBundle.entries.find(
                                entry => entry.entryCode.trim().toUpperCase() === entryCode.trim().toUpperCase()
                            );
                            
                            if (entry) {
                                return {
                                    auditBundle,
                                    filePath: file.path,
                                    entry
                                };
                            }
                        }
                    } catch (err) {
                        // Skip files that can't be parsed
                        console.warn(`Could not parse ${file.path}:`, err);
                        continue;
                    }
                }
                
                // Entry not found in any draw
                return null;
            } catch (error) {
                console.error('Error searching GitHub:', error);
                throw new Error('Failed to search audit bundles. Please try again later.');
            }
        }

        // Fetch an audit bundle from GitHub
        async function fetchAuditBundle(filePath) {
            const url = `https://raw.githubusercontent.com/${CONFIG.GITHUB_OWNER}/${CONFIG.GITHUB_REPO}/main/${filePath}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch audit bundle');
            return response.json();
        }

        // Handle tooltip interactions for touch devices
        function initializeTooltips() {
            let activeTooltip = null;

            // Handle touch events for mobile devices
            document.addEventListener('click', (event) => {
                const tooltip = event.target.closest('.hash-tooltip');
                
                if (tooltip) {
                    event.preventDefault();
                    
                    // Close previously active tooltip
                    if (activeTooltip && activeTooltip !== tooltip) {
                        activeTooltip.classList.remove('active');
                    }
                    
                    // Toggle current tooltip
                    tooltip.classList.toggle('active');
                    activeTooltip = tooltip.classList.contains('active') ? tooltip : null;
                } else if (activeTooltip) {
                    // Close tooltip when clicking outside
                    activeTooltip.classList.remove('active');
                    activeTooltip = null;
                }
            });

            // Close tooltip on escape key
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && activeTooltip) {
                    activeTooltip.classList.remove('active');
                    activeTooltip = null;
                }
            });
        }

        // Initialize tooltips when page loads
        initializeTooltips();
    </script>
     <script>
        // Send height to parent window for iframe auto-sizing
        (function() {
          function sendHeight() {
            const height = document.documentElement.scrollHeight;
            window.parent.postMessage({
              type: 'resize',
              height: height
            }, '*'); // Use '*' to allow any parent domain
          }
          
          window.addEventListener('load', sendHeight);
          
          const observer = new MutationObserver(sendHeight);
          observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true
          });
          
          setInterval(sendHeight, 500);
          window.addEventListener('resize', sendHeight);
        })();
    </script>
</body>
</html>
